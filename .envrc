#!/usr/bin/env bash

set -e

PROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

export PROOT

PATH_add "$HOME/.bun/bin"
PATH_add "$HOME/.task"
PATH_add "$HOME/.local/bin"
PATH_add "./bin"

use_bun() {
  watch_file .bun-version
  local desired_version
  desired_version=$(cat "$PROOT/.bun-version" 2>/dev/null || echo "latest")

  if ! command -v bun >/dev/null 2>&1; then
    echo "Installing Bun v${desired_version}" >&2
    curl -fsSL https://bun.sh/install | bash -s "bun-v${desired_version}"
  else
    local current_version
    current_version=$(bun --version)
    if [[ "$current_version" != "$desired_version" ]]; then
      echo "Switching Bun from v${current_version} to v${desired_version}" >&2
      curl -fsSL https://bun.sh/install | bash -s "bun-v${desired_version}"
    fi
  fi

  PATH_add "$HOME/.bun/bin"
  bun install
}

use_task() {
  if ! command -v task >/dev/null 2>&1; then
    echo "Installing Task" >&2
    bun run src/main.ts download task
  fi

  PATH_add "$HOME/.task"
}

use_bun && use_task
